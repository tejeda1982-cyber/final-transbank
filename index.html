<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chatbot TumotoExpress</title>
<style>
body { font-family: Arial; background-color: #ece5dd; margin:0; padding:0; }
.chat-container { width: 420px; max-width:95%; margin:40px auto; background:#fff; border-radius:10px; box-shadow:0 0 12px rgba(0,0,0,0.2); display:flex; flex-direction:column; height:650px; }
.title { text-align:center; font-weight:bold; font-size:20px; margin:15px 0; color:#075e54; }
.agent-name { text-align:center; font-weight:bold; margin-bottom:10px; color:#128c7e; }
.chat-log { flex:1; overflow-y:auto; padding:15px; background-color:#e5ddd5; }
.message { margin:5px 0; max-width:75%; padding:8px 12px; border-radius:10px; clear:both; word-wrap:break-word; }
.bot-message { background-color:#25d366; color:#fff; float:left; }
.user-message { background-color:#dcf8c6; color:#000; float:right; }
.input-container { display:flex; padding:10px; gap:5px; border-top:1px solid #ddd; background-color:#f0f0f0; }
input { flex:1; padding:8px; border-radius:5px; border:1px solid #ccc; font-size:14px; }
button { padding:8px 12px; border:none; border-radius:5px; background-color:#128c7e; color:white; cursor:pointer; font-weight:bold; }
button:hover { background-color:#075e54; }
</style>
</head>
<body>
<div class="chat-container">
<div class="title">ðŸ’° CotizaciÃ³n</div>
<div id="agent" class="agent-name">Agente: Lucas</div>
<div class="chat-log" id="chatLog"></div>

<div class="input-container">
  <input type="text" id="inputMsg" placeholder="Escribe tu mensaje...">
  <button id="sendBtn">Enviar</button>
</div>
</div>

<script>
const chatLog = document.getElementById('chatLog');
const inputMsg = document.getElementById('inputMsg');
const sendBtn = document.getElementById('sendBtn');
const agentNameEl = document.getElementById('agent');

const agentes = ["Lucas", "Francisco", "Gina"];
let ultimoAgenteIndex = 0;

function actualizarAgente(){ 
  ultimoAgenteIndex = (ultimoAgenteIndex+1)%agentes.length; 
  agentNameEl.innerText="Agente: "+agentes[ultimoAgenteIndex]; 
  return agentes[ultimoAgenteIndex]; 
}

function agregarMensaje(texto, tipo){ 
  const div=document.createElement('div'); 
  div.className='message '+(tipo==='bot'?'bot-message':'user-message'); 
  div.innerText=texto; 
  chatLog.appendChild(div); 
  chatLog.scrollTop=chatLog.scrollHeight; 
}

let estado="inicio";
let respuestas={};

function iniciarChat(){
  agregarMensaje("ðŸ‘‹ Hola! Bienvenido a TumotoExpress. Elige una opciÃ³n:\n1ï¸âƒ£ Cotizar envÃ­o\n2ï¸âƒ£ Hablar con un agente",'bot');
  estado="opcion";
}

function enviarPedido(res){
  const agente = actualizarAgente();
  agregarMensaje("ðŸ“¨ Registrando pedido (simulado)...",'bot');
  console.log("Pedido:", res, "Agente asignado:", agente);
  agregarMensaje(`âœ… Pedido registrado. Agente asignado: ${agente}`,'bot');
}

async function cotizarEnvio(inicio,destino){
  agregarMensaje("ðŸ’µ Calculando cotizaciÃ³n...",'bot');
  try{
    const res=await fetch('/cotizar',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({inicio,destino})
    });
    const data=await res.json();
    if(data.error){ agregarMensaje("âŒ Error calculando cotizaciÃ³n",'bot'); estado="fin"; return false;}
    else{
      respuestas.total=data.total_a_pagar;
      respuestas.distancia=data.distancia_km;
      agregarMensaje(`ðŸ’° Distancia: ${data.distancia_km.toFixed(2)} km\nTotal a pagar: $${data.total_a_pagar}\n1ï¸âƒ£ Aceptar  2ï¸âƒ£ Rechazar`,'bot');
      estado="confirmarCot";
      return true;
    }
  }catch(e){ agregarMensaje("âŒ Error conectando con servidor",'bot'); estado="fin"; return false; }
}

function procesarMensaje(msg){
  if(!msg) return;
  agregarMensaje(msg,'user');
  inputMsg.value=''; // limpia input despuÃ©s de enviar
  inputMsg.focus();   // cursor en input

  switch(estado){
    case "inicio": iniciarChat(); break;
    case "opcion":
      if(msg==='1' || msg.toLowerCase().includes("cotizar")){ 
        respuestas={}; estado="inicioDir"; 
        agregarMensaje("ðŸ“ Ingresa la direcciÃ³n de inicio",'bot');
      } else if(msg==='2' || msg.toLowerCase().includes("agente")){
        agregarMensaje("â˜Žï¸ Un agente se pondrÃ¡ en contacto contigo.",'bot'); estado="fin";
      } else agregarMensaje("âŒ OpciÃ³n no vÃ¡lida. Escribe 1 o 2",'bot');
      break;
    case "inicioDir": respuestas.inicio=msg; estado="destinoDir"; agregarMensaje("ðŸ“ Ingresa la direcciÃ³n de destino",'bot'); break;
    case "destinoDir": respuestas.destino=msg; estado="calcularCot"; cotizarEnvio(respuestas.inicio,respuestas.destino); break;
    case "confirmarCot":
      if(msg==='1' || msg.toLowerCase().includes("sÃ­")){ estado="remitente"; agregarMensaje("ðŸ“ Ingresa tu nombre completo",'bot'); }
      else if(msg==='2' || msg.toLowerCase().includes("no")){ agregarMensaje("âŒ CotizaciÃ³n rechazada. Fin del proceso",'bot'); estado="fin"; }
      else agregarMensaje("âŒ Responde 1ï¸âƒ£ para aceptar, 2ï¸âƒ£ para rechazar",'bot');
      break;
    case "remitente": respuestas.remitente_nombre=msg; estado="telefono"; agregarMensaje("ðŸ“ž Ingresa tu telÃ©fono",'bot'); break;
    case "telefono": respuestas.remitente_telefono=msg; estado="destinatarioNombre"; agregarMensaje("ðŸ“ Nombre del destinatario",'bot'); break;
    case "destinatarioNombre": respuestas.destinatario_nombre=msg; estado="destinatarioTelefono"; agregarMensaje("ðŸ“ž TelÃ©fono del destinatario",'bot'); break;
    case "destinatarioTelefono": respuestas.destinatario_telefono=msg; estado="detalle"; agregarMensaje("ðŸ“¦ Detalle del pedido",'bot'); break;
    case "detalle": respuestas.detalle=msg; estado="fin"; enviarPedido(respuestas); break;
    case "fin": agregarMensaje("âœ… Proceso finalizado. Gracias por usar TumotoExpress!",'bot'); break;
  }
}

sendBtn.addEventListener('click',()=>procesarMensaje(inputMsg.value.trim()));
inputMsg.addEventListener('keypress',e=>{ if(e.key==='Enter') procesarMensaje(inputMsg.value.trim()); });

estado="inicio";
procesarMensaje("");
</script>
</body>
</html>



