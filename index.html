<script>
async function cotizar() {
  const inicio = document.getElementById("inicio").value;
  const destino = document.getElementById("destino").value;
  const codigo_cupon = document.getElementById("codigoCupon").value.trim().toUpperCase();

  if(!inicio || !destino){ alert("Completa origen y destino"); return; }

  const spinner = document.getElementById("spinner"); spinner.style.display="block";

  try {
    // ğŸ”¹ URL modificada para apuntar al nuevo backend de Render
    const response = await fetch("https://final-transbank.onrender.com/cotizar", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ inicio, destino, cupon: codigo_cupon })
    });

    const data = await response.json();
    spinner.style.display="none";

    if(data.error){ alert(data.error); return; }

    const resultadoDiv = document.getElementById("resultado");
    resultadoDiv.style.display="block";

    // Mostrar neto original
    let html = `
      <strong>ğŸ“ Origen:</strong> ${data.inicio}<br>
      <strong>ğŸ“ Destino:</strong> ${data.destino}<br><br>
      <strong>ğŸ“ Distancia:</strong> ${data.distancia_km.toFixed(2)} km<br>
      <strong>ğŸ’µ Neto:</strong> $${data.neto}<br>
    `;

    // Mostrar descuento si aplica
    if(data.descuentoValor && data.descuentoTexto) {
      html += `<strong>ğŸŸï¸ ${data.descuentoTexto}:</strong> -$${data.descuentoValor}<br>`;
      html += `<strong>ğŸ’µ Neto con descuento:</strong> $${data.netoConDescuento}<br>`;
    }

    // IVA y total
    html += `
      <strong>ğŸ§¾ IVA:</strong> $${data.iva}<br>
      <strong>ğŸ’³ Total:</strong> <strong>$${data.total}</strong>
      <br><br><em>${obtenerMensajeHoraEstimado()}</em>
    `;

    resultadoDiv.innerHTML = html;

    const telefono="56942325524";
    const mensaje = encodeURIComponent(`Hola, acepto el servicio de TuMotoExpress.cl.\nOrigen: ${data.inicio}\nDestino: ${data.destino}\nDistancia: ${data.distancia_km.toFixed(2)} km\nTotal: $${data.total}\n${obtenerMensajeHoraEstimado()}`);
    const link=`https://wa.me/${telefono}?text=${mensaje}`;
    const btn = document.getElementById("btnWhatsapp"); btn.style.display="block"; btn.onclick = () => window.open(link,"_blank");

  } catch(err){ spinner.style.display="none"; console.error(err); alert("Error al cotizar, revisa tu backend"); }
}
</script>